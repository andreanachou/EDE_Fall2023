---
title: "NCUC Disconnection Data"
output: html_document
date: "2023-10-24"
runtime: shiny
---
```{r load, echo=FALSE}
library(tidyverse)
library(shiny)
library(dplyr)
library(here)
library(yaml)
library(trend)
library(zoo)
library(Kendall)
library(tseries)
library(conflicted)

disconnections <- read.csv(here("./NCUC_Disconnection_1996_2022.csv"), 
                           stringsAsFactors = TRUE,
                           header = TRUE)
disconnections <- disconnections %>% mutate(Date = make_date(
  month = Month, year = Year))
```

```{r select box company, echo=FALSE}
selectInput(inputId = "company",
            label = h3("Select electric utility"), 
            choices = list("Duke Energy Carolinas" = "Duke Energy Carolinas", 
                   "Duke Energy Progress" = "Duke Energy Progress", 
                   "Dominion" = "Dominion",
                   "New River Light & Power" = "New River Light & Power",
                   "Nantahala" = "Nantahala"), 
    selected = "N/A")

selectInput(inputId = "month",
            label = h3("Select month"), 
            choices = list(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12), 
    selected = "N/A")

selectInput(inputId = "year",
            label = h3("Select year"), 
            choices = list(2022, 2021, 2020, 2019, 2018, 2017, 2016, 2015, 2014,
                           2013, 2012, 2011, 2010, 2009, 2008, 2007, 2006, 2005,
                           2004, 2003, 2002, 2001, 2000, 1999, 1998, 1997, 1996), 
    selected = "N/A")

#monthly.value <- disconnections %>% select_if()
#select_if() needs to use a table object

#monthly.value <- extract(disconnections, disconnections[1] == input$month, disconnections[2] == input$year, disconnections[3] == input$company)

#renderPrint(print("Number of disconnections for", input$company,"is", 
                  #disconnections[disconnections$Company == input$company,
                                 #disconnections$Month == input$month,
                                 #disconnections$Year == input$year]))

#filter data by inputs 
#how to extract a value from table based on givens
#specify location of print

#select_if()
```

```{r base plot, echo=FALSE}

year <- 2010
company <- "Duke Energy Progress"

base.df <- disconnections %>% dplyr::filter(Year == year, Company == company)

base.df$Number_Disconnections_Res <- as.numeric(base.df$Number_Disconnections_Res)

baseplot <- base.df %>% 
  ggplot(aes(x=factor(Month, levels=1:12, labels=month.abb),y=Number_Disconnections_Res)) +
  labs(x = "Month", y = "Number of Residential Disconnections") +
  geom_point()
  geom_line()
baseplot


```


```{r base plot with variable input, echo=FALSE}

disconnections$Number_Disconnections_Res <- as.numeric(disconnections$Number_Disconnections_Res)

baseplot2 <- function(df, year2, company2) {
  plot2 <- df %>% 
  dplyr::filter(Year == year2, Company == company2) %>%
  ggplot(aes(x=factor(Month, levels=1:12, labels=month.abb),
             y=Number_Disconnections_Res)) + 
  labs(x = "Month", y = "Number of Residential Disconnections") +
  geom_point()
  
  return(plot2)
  }


# can't seem to convert Number_Disconnection_Res into numeric, error in disconnections object cannot be coerced to type "double"

#series is not periodic or has less than two periods

renderPlot(baseplot2(disconnections, input$year, input$company))

```


```{r}
#yearly.graph.df <- disconnections %>% dplyr::filter(Year == year) %>%
  #dplyr::filter(Company == company)

```


```{r time series all}

renderPlot(
  disconnections.complete <- disconnections %>% 
  dplyr::filter(Company == input$company)

#na's use zoo package
#object input not found when using input$year

disconnections.ts <- ts(disconnections.complete$Number_Disconnections_Res, 
                        start=c(1996, 01, 01), frequency=12)

#COMMA for start

disconnections.decomp <- stl(disconnections.ts, s.window="periodic")
#series is not periodic or has less than two periods
plot(disconnections.decomp)
)

#see time series plot before decomposition
#potentially to visualize performance across companies (time series or initial month)
#convert N/As to zeros 

```

```{r time series analysis}

#disconnections.smk <- SeasonalMannKendall(disconnections.ts)

```

```{r time series monthly}
#selected_year <- 1996

#dominion_subset <- disconnections %>% filter(Company == "North Carolina Power") %>%
  #mutate(Year = 1996)

#dominion_subset_ts <- ts(dominion_subset$Number_Disconnections_Res,
                         #start=c(1996), frequency=12)

#dominion_decomp <- stl(dominion_subset_ts, s.window="periodic")
#plot(dominion_decomp)

```
=======

>>>>>>> 11ec302e08f47f318d70db723b2930aa3514d7b5
